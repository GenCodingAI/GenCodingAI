<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GenCoding AI - The Best AI Programming Assistant</title>
<meta name="google-site-verification" content="AIzaSyDsWqMO9cbFeHrLMVhYiPrIqpfk-5aeCT8" />
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- JWT decode (Google sign-in) -->
<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

<style>
  /* Reset and base */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color, #f0f8ff);
    color: var(--text-color, #222);
    transition: background-color 0.3s ease, color 0.3s ease;
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
  }
  a {
    color: var(--accent-color, #33aaffcc);
  }

  /* Variables for themes */
  :root {
    --bg-color: #f0f8ff;
    --text-color: #222;
    --accent-color: #33aaffcc;
    --message-user-bg: #cde4ff;
    --message-bot-bg: #99ccff;
  }

  /* Dark mode variables */
  body.dark-mode {
    --bg-color: #001022;
    --text-color: #a0c8ffdd;
    --accent-color: #44aaffcc;
    --message-user-bg: #3366ff;
    --message-bot-bg: #004d99;
  }

  /* Page layout */
  .page {
    display: grid;
    grid-template-columns: 260px 1fr;
    grid-template-rows: 64px 1fr 44px;
    grid-template-areas:
      "sidebar header"
      "sidebar main"
      "sidebar footer";
    height: 100vh;
    background: var(--bg-color);
    color: var(--text-color);
    overflow: hidden;
  }

  .sidebar {
    grid-area: sidebar;
    background: #d0e9ffcc;
    border-right: 2px solid #55aaffcc;
    box-shadow: inset -2px 0 20px #99ccff66;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .sidebar-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo-img {
    width: 42px;
    height: 42px;
    object-fit: contain;
  }

  .logo-text {
    font-weight: 900;
    font-size: 1.8rem;
    color: var(--accent-color);
    text-shadow: 0 0 8px var(--accent-color);
  }

  .nav-tabs {
    display: flex;
    flex-direction: column;
  }

  .nav-tab {
    background: transparent;
    border: none;
    border-left: 4px solid transparent;
    padding: 14px 20px;
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--accent-color);
    cursor: pointer;
    text-align: left;
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }

  .nav-tab:hover {
    background-color: #a6cdfd88;
  }

  .nav-tab.active {
    background-color: #66bbffcc;
    border-left-color: #3388ffcc;
    box-shadow: inset 6px 0 12px #3388ffcc;
    color: #002233;
  }

  .sidebar-footer {
    padding: 12px 20px;
    font-size: 0.9rem;
    color: #3388ffcc;
    text-align: center;
    user-select: none;
  }

  header.header {
    grid-area: header;
    background: #a6cdfd88;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 24px;
    border-bottom: 2px solid #55bbffcc;
    box-shadow: inset 0 -2px 10px #77bbffcc;
  }

  .header-left h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--accent-color);
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  #googleSignInDiv button {
    cursor: pointer;
  }

  .btn {
    background: var(--accent-color);
    border: none;
    border-radius: 20px;
    padding: 10px 24px;
    font-weight: 700;
    font-size: 1.05rem;
    color: #dceeff;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 0 20px var(--accent-color);
    transition: background-color 0.3s ease;
  }

  .btn:hover {
    background: #44aaffee;
    box-shadow: 0 0 32px #44aaffee;
  }

  .btn:active {
    transform: scale(0.95);
  }

  main.main {
    grid-area: main;
    padding: 20px 32px;
    overflow-y: auto;
    background: var(--bg-color);
  }

  footer.footer {
    grid-area: footer;
    padding: 12px 20px;
    text-align: center;
    font-size: 0.9rem;
    color: var(--accent-color);
    background: #a6cdfd88;
    border-top: 2px solid #55bbffcc;
    box-shadow: inset 0 2px 12px #77bbffcc;
  }

  /* Tab content */
  .tab-content {
    display: none;
    height: 100%;
    overflow-y: auto;
    outline: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Chat container */
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .chat-header {
    font-weight: 900;
    font-size: 1.4rem;
    margin-bottom: 12px;
    color: var(--accent-color);
  }

  .messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 12px;
    background: #d4eaffcc;
    border-radius: 14px;
    box-shadow: inset 0 0 22px #66bbffcc;
    color: #002244;
  }

  .message {
    padding: 8px 14px;
    margin-bottom: 10px;
    border-radius: 18px;
    max-width: 75%;
    word-wrap: break-word;
    position: relative;
  }

  .message.bot {
    background: var(--message-bot-bg);
    color: var(--text-color);
    margin-left: auto;
  }

  .message.user {
    background: var(--message-user-bg);
    color: var(--text-color);
    margin-right: auto;
  }

  /* Message edit/delete controls */
  .message-controls {
    display: inline-flex;
    gap: 8px;
    margin-left: 12px;
    position: absolute;
    right: 8px;
    top: 8px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .message.user:hover .message-controls {
    opacity: 1;
  }

  .message-controls button {
    background: transparent;
    border: 1px solid var(--accent-color);
    border-radius: 6px;
    padding: 2px 8px;
    font-size: 0.75rem;
    cursor: pointer;
    color: var(--accent-color);
    user-select: none;
    transition: background-color 0.2s ease;
  }

  .message-controls button:hover {
    background-color: var(--accent-color);
    color: #001011;
  }

  /* Chat input container */
  .chat-input-container {
    margin-top: 12px;
    display: flex;
    gap: 12px;
  }

  #chatInput {
    flex-grow: 1;
    resize: vertical;
    min-height: 38px;
    max-height: 100px;
    padding: 12px 14px;
    font-size: 1.05rem;
    border-radius: 18px;
    border: 1.8px solid var(--accent-color);
    box-shadow: inset 0 0 12px var(--accent-color);
    outline: none;
    transition: border-color 0.3s ease;
  }

  #chatInput:focus {
    border-color: #66bbff;
    box-shadow: inset 0 0 20px #66bbff;
  }

  .btn-send {
    min-width: 120px;
  }

  /* Contact form */
  .contact-container {
    max-width: 560px;
    margin: auto;
  }

  .contact-form label {
    display: block;
    font-weight: 700;
    margin: 14px 0 6px;
    color: var(--accent-color);
  }

  .contact-form input[type="text"],
  .contact-form input[type="email"],
  .contact-form textarea {
    width: 100%;
    padding: 10px 14px;
    border-radius: 14px;
    border: 1.6px solid var(--accent-color);
    font-size: 1rem;
    color: var(--text-color);
    resize: vertical;
  }

  .contact-form input:focus,
  .contact-form textarea:focus {
    border-color: #66bbff;
    box-shadow: inset 0 0 16px #66bbff;
    outline: none;
  }

  .contact-form button {
    margin-top: 16px;
  }

  /* Premium tab */
  .premium-container {
    max-width: 900px;
    margin: auto;
  }

  .premium-cards {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .premium-card {
    background: #a6cdfd88;
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 0 40px #3388ffcc inset;
    width: 260px;
    color: var(--text-color);
    cursor: pointer;
    transition: box-shadow 0.3s ease;
  }

  .premium-card:hover,
  .premium-card:focus {
    box-shadow: 0 0 64px #66bbffcc inset;
  }

  .premium-card h4 {
    margin-top: 0;
    font-weight: 900;
    font-size: 1.4rem;
    margin-bottom: 12px;
  }

  .premium-card ul {
    list-style: disc inside;
    padding-left: 0;
  }

  /* Settings tab */
  .settings-container {
    max-width: 520px;
    margin: auto;
  }

  .settings-container h3 {
    font-weight: 900;
    font-size: 2rem;
    color: var(--accent-color);
    margin-bottom: 24px;
    text-shadow:
      0 0 15px var(--accent-color);
  }

  .settings-group {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .settings-group label {
    font-weight: 700;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: default;
  }

  .settings-group input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--accent-color);
    border-radius: 6px;
    box-shadow: 0 0 6px var(--accent-color) inset;
    transition: box-shadow 0.3s ease;
  }

  .settings-group input[type="checkbox"]:hover {
    box-shadow: 0 0 12px #55bbffcc inset;
  }

  .settings-group input[type="checkbox"]:checked {
    box-shadow: 0 0 24px var(--accent-color) inset;
  }

  /* Buttons container */
  .settings-buttons {
    margin-top: 32px;
    display: flex;
    gap: 16px;
    justify-content: center;
  }

  .settings-buttons button {
    background: var(--accent-color);
    border-radius: 20px;
    border: none;
    padding: 14px 36px;
    color: #dceeff;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow:
      0 0 25px var(--accent-color);
    user-select: none;
    transition: background-color 0.3s ease;
  }

  .settings-buttons button:hover {
    background: #44aaffee;
    box-shadow:
      0 0 36px #44aaffee;
  }

  .settings-buttons button:active {
    transform: scale(0.96);
  }

  /* Responsive tweaks */
  @media (max-width: 820px) {
    .page {
      grid-template-columns: 1fr;
      grid-template-rows: 64px 1fr 44px;
      grid-template-areas:
        "header"
        "main"
        "footer";
      border-radius: 0;
    }
    .sidebar {
      display: none;
    }
    .header-left h2 {
      font-size: 1.3rem;
    }
    .main {
      padding: 16px 20px;
    }
  }
</style>
</head>
<body>
  <div class="page" role="application" aria-label="GenBot AI chat interface">
    <nav class="sidebar" aria-label="Primary navigation">
      <div class="sidebar-header">
        <img class="logo-img" src="https://i.imgur.com/J2bRVPq.png" alt="GenBot Logo" />
        <h1 class="logo-text">GenBot</h1>
      </div>
      <div class="nav-tabs" role="tablist" aria-orientation="vertical">
        <button class="nav-tab active" id="tab-chat" role="tab" aria-selected="true" aria-controls="tabpanel-chat" tabindex="0">Chat</button>
        <button class="nav-tab" id="tab-contact" role="tab" aria-selected="false" aria-controls="tabpanel-contact" tabindex="-1">Contact</button>
        <button class="nav-tab" id="tab-premium" role="tab" aria-selected="false" aria-controls="tabpanel-premium" tabindex="-1">Premium</button>
        <button class="nav-tab" id="tab-settings" role="tab" aria-selected="false" aria-controls="tabpanel-settings" tabindex="-1">Settings</button>
      </div>
      <div class="sidebar-footer" tabindex="0">Made with âœ¨ and neon glow by GenCodingAI</div>
    </nav>

    <header class="header">
      <div class="header-left">
        <h2 id="current-tab-title">Chat</h2>
      </div>
      <div class="header-right">
        <div id="googleSignInDiv" aria-label="Google sign-in button"></div>
        <button id="btnLogout" class="btn" hidden aria-label="Log out from Google">Logout</button>
      </div>
    </header>

    <main class="main">
      <!-- CHAT TAB -->
      <section id="tabpanel-chat" class="tab-content active" role="tabpanel" aria-labelledby="tab-chat" tabindex="0">
        <div class="chat-container">
          <div class="chat-header" aria-live="polite" aria-atomic="true">Free Coding AI</div>
          <div class="messages" id="chatMessages" aria-live="polite" aria-relevant="additions"></div>
          <div class="chat-input-container">
            <textarea id="chatInput" placeholder="Type your question and press Enter..." aria-label="Chat input"></textarea>
            <button id="btnSend" class="btn btn-send" aria-label="Send chat message">Send</button>
          </div>
        </div>
      </section>

      <!-- CONTACT TAB -->
      <section id="tabpanel-contact" class="tab-content" role="tabpanel" aria-labelledby="tab-contact" tabindex="0">
        <div class="contact-container">
          <h3>Contact GenBot Team</h3>
          <form id="contactForm" class="contact-form" novalidate>
            <label for="contactName">Name</label>
            <input type="text" id="contactName" name="contactName" placeholder="Your full name" required minlength="2" maxlength="100" />
            
            <label for="contactEmail">Email</label>
            <input type="email" id="contactEmail" name="contactEmail" placeholder="your.email@example.com" required />

            <label for="contactMessage">Message</label>
            <textarea id="contactMessage" name="contactMessage" placeholder="Write your message here..." required minlength="5" maxlength="2000" rows="6"></textarea>

            <button type="submit" class="btn">Send Message</button>
          </form>
          <div id="contactResponse" role="alert" aria-live="assertive" style="margin-top: 16px; color: var(--accent-color); font-weight: 700;"></div>
        </div>
      </section>

      <!-- PREMIUM TAB -->
      <section id="tabpanel-premium" class="tab-content" role="tabpanel" aria-labelledby="tab-premium" tabindex="0">
        <div class="premium-container">
          <h3>Upgrade to Premium</h3>
          <div class="premium-cards">
            <div class="premium-card" tabindex="0" role="button" aria-pressed="false" data-level="basic">
              <h4>Basic Premium</h4>
              <ul>
                <li>Faster response times</li>
                <li>Extra chat history saved</li>
                <li>Priority AI personalities</li>
              </ul>
              <p><strong>$4.99 / month</strong></p>
              <button class="btn btn-buy" aria-label="Buy Basic Premium">Buy</button>
            </div>
            <div class="premium-card" tabindex="0" role="button" aria-pressed="false" data-level="pro">
              <h4>Pro Premium</h4>
              <ul>
                <li>Everything in Basic</li>
                <li>Custom AI personalities</li>
                <li>Code export & collaboration</li>
                <li>Offline mode (soon)</li>
              </ul>
              <p><strong>$9.99 / month</strong></p>
              <button class="btn btn-buy" aria-label="Buy Pro Premium">Buy</button>
            </div>
          </div>
          <p style="margin-top: 32px; text-align: center;">* Premium subscriptions coming soon. Stay tuned!</p>
        </div>
      </section>

      <!-- SETTINGS TAB -->
      <section id="tabpanel-settings" class="tab-content" role="tabpanel" aria-labelledby="tab-settings" tabindex="0">
        <div class="settings-container">
          <h3>Settings & Preferences</h3>
          <div class="settings-group">
            <label for="settingAutoSave">
              <input type="checkbox" id="settingAutoSave" />
              Auto-save chat history to cloud
            </label>
            <label for="settingDarkMode">
              <input type="checkbox" id="settingDarkMode" />
              Dark mode
            </label>
            <label for="personalitySelect">
              AI Personality:
              <select id="personalitySelect" aria-label="Select AI personality">
                <option value="friendly">Friendly</option>
                <option value="professional">Professional</option>
                <option value="funny">Funny</option>
                <option value="concise">Concise</option>
                <option value="detailed">Detailed</option>
              </select>
            </label>
          </div>
          <div class="settings-group-theme"></div>
          <div class="settings-buttons">
            <button id="btnExport" class="btn" aria-label="Export chat history">Export Chat</button>
            <button id="btnClear" class="btn" aria-label="Clear chat history">Clear Chat</button>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer" role="contentinfo">
      Â© 2025 GenCoding AI - All rights reserved
    </footer>
  </div>
</body>
</html>
<script>
// ========== Firebase Setup ==========
const firebaseConfig = {
  apiKey: "AIzaSyAXaZdG3cJ4TImgpVe3vu27DYHj2qvGFV8",
  authDomain: "genbot-d3d1c.firebaseapp.com",
  projectId: "genbot-d3d1c",
  storageBucket: "genbot-d3d1c.firebasestorage.app",
  messagingSenderId: "999486908596",
  appId: "1:999486908596:web:dad878c0babe809ece4fe1"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========== Global Variables ==========
let googleUser = null;
let chatHistory = [];
let chatListenersUnsub = null;
let autoSaveEnabled = false;
let darkModeEnabled = false;
let currentPersonality = 'friendly';
let animationsEnabled = true;
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const btnSend = document.getElementById('btnSend');
const tabs = document.querySelectorAll('.nav-tab');
const tabContents = document.querySelectorAll('.tab-content');
const currentTabTitle = document.getElementById('current-tab-title');
const contactForm = document.getElementById('contactForm');
const btnLogout = document.getElementById('btnLogout');
const settingAutoSave = document.getElementById('settingAutoSave');
const settingDarkMode = document.getElementById('settingDarkMode');
const personalitySelect = document.getElementById('personalitySelect');
const btnExport = document.getElementById('btnExport');
const btnClear = document.getElementById('btnClear');

// ========== Helper: Animate typing effect ==========
async function typeMessage(text, container, delay=30) {
  container.textContent = '';
  for (const char of text) {
    container.textContent += char;
    await new Promise(res => setTimeout(res, delay));
  }
}

// ========== Chat UI functions ==========

// Clear chat messages UI
function clearMessages() {
  chatMessages.innerHTML = '';
}

// Add message to UI with animation & optional editing controls for user messages
function addMessage(msgObj) {
  const { id, text, fromBot } = msgObj;
  const msgDiv = document.createElement('div');
  msgDiv.classList.add('message', fromBot ? 'bot' : 'user');
  msgDiv.dataset.id = id || '';
  msgDiv.setAttribute('tabindex', 0);

  if (animationsEnabled && fromBot) {
    // live typing effect container
    const typingSpan = document.createElement('span');
    msgDiv.appendChild(typingSpan);
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    typeMessage(text, typingSpan);
  } else {
    msgDiv.textContent = text;
    chatMessages.appendChild(msgDiv);
  }

  if (!fromBot) {
    // Add edit/delete controls
    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'message-controls';
    const btnEdit = document.createElement('button');
    btnEdit.textContent = 'Edit';
    btnEdit.title = 'Edit message';
    btnEdit.addEventListener('click', () => editMessage(id));
    const btnDelete = document.createElement('button');
    btnDelete.textContent = 'Delete';
    btnDelete.title = 'Delete message';
    btnDelete.addEventListener('click', () => deleteMessage(id));
    controlsDiv.appendChild(btnEdit);
    controlsDiv.appendChild(btnDelete);
    msgDiv.appendChild(controlsDiv);
  }

  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Edit a user message inline and update Firestore
function editMessage(msgId) {
  const msgDiv = chatMessages.querySelector(`.message.user[data-id="${msgId}"]`);
  if (!msgDiv) return;
  if (msgDiv.querySelector('textarea')) return; // already editing

  const oldText = msgDiv.firstChild.textContent || '';
  const textarea = document.createElement('textarea');
  textarea.value = oldText;
  textarea.style.width = '100%';
  textarea.style.minHeight = '60px';
  textarea.style.fontSize = '1rem';
  textarea.style.borderRadius = '12px';
  textarea.style.padding = '8px';
  textarea.style.marginTop = '8px';

  // Replace message text with textarea
  msgDiv.innerHTML = '';
  msgDiv.appendChild(textarea);
  textarea.focus();

  // Save on blur or Enter (without shift)
  function saveEdit() {
    const newText = textarea.value.trim();
    if (newText.length < 1) {
      alert('Message cannot be empty.');
      textarea.focus();
      return;
    }
    updateMessage(msgId, newText);
    textarea.removeEventListener('blur', saveEdit);
    textarea.removeEventListener('keydown', onKeydown);
  }
  function onKeydown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      saveEdit();
    }
  }
  textarea.addEventListener('blur', saveEdit);
  textarea.addEventListener('keydown', onKeydown);
}

// Delete a user message and update Firestore
function deleteMessage(msgId) {
  if (!confirm('Delete this message? This action cannot be undone.')) return;
  if (!googleUser) {
    alert('Sign in first to delete messages.');
    return;
  }
  const userId = googleUser.sub;
  const chatRef = db.collection('users').doc(userId).collection('chatMessages').doc(msgId);
  chatRef.delete().catch(e => alert('Error deleting message: ' + e.message));
}

// Render full chat history from array
function renderChatHistory(history) {
  clearMessages();
  for (const msg of history) {
    addMessage(msg);
  }
}

// ========== Firebase Chat History Handling ==========

// Load chat messages from Firestore & listen to real-time updates
function listenToChatUpdates() {
  if (!googleUser) return;
  if (chatListenersUnsub) chatListenersUnsub();

  const userId = googleUser.sub;
  const chatColRef = db.collection('users').doc(userId).collection('chatMessages').orderBy('timestamp');
  chatListenersUnsub = chatColRef.onSnapshot(snapshot => {
    const updatedHistory = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      updatedHistory.push({
        id: doc.id,
        text: data.text,
        fromBot: data.fromBot,
        timestamp: data.timestamp ? data.timestamp.toMillis() : 0,
      });
    });
    chatHistory = updatedHistory;
    renderChatHistory(chatHistory);
  });
}

// Save a new chat message to Firestore
function saveChatMessage(text, fromBot) {
  if (!googleUser || !autoSaveEnabled) return;
  const userId = googleUser.sub;
  const chatColRef = db.collection('users').doc(userId).collection('chatMessages');
  return chatColRef.add({
    text,
    fromBot,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}

// Update message text by ID in Firestore (only for user messages)
function updateMessage(msgId, newText) {
  if (!googleUser) return;
  const userId = googleUser.sub;
  const docRef = db.collection('users').doc(userId).collection('chatMessages').doc(msgId);
  docRef.update({ text: newText }).catch(e => alert('Update failed: ' + e.message));
}

// Clear chat history Firestore and local state
function clearChatHistory() {
  if (!googleUser) return;
  const userId = googleUser.sub;
  const chatColRef = db.collection('users').doc(userId).collection('chatMessages');
  chatColRef.get().then(snapshot => {
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    return batch.commit();
  }).then(() => {
    chatHistory = [];
    clearMessages();
  }).catch(e => alert('Error clearing chat: ' + e.message));
}

// ========== UI Logic ==========

// Switch tabs UI & ARIA attributes
function switchTab(tabId) {
  tabs.forEach(t => {
    const active = t.id === tabId;
    t.classList.toggle('active', active);
    t.setAttribute('aria-selected', active ? 'true' : 'false');
    t.tabIndex = active ? 0 : -1;
  });
  tabContents.forEach(tc => {
    const matchId = 'tabpanel-' + tabId.slice(4);
    const isActive = tc.id === matchId;
    tc.classList.toggle('active', isActive);
    if (isActive) tc.focus();
  });
  currentTabTitle.textContent = tabId.slice(4).charAt(0).toUpperCase() + tabId.slice(5);
}

// Validate contact form fields, returns true if valid
function validateContactForm() {
  const nameInput = contactForm.contactName;
  const emailInput = contactForm.contactEmail;
  const messageInput = contactForm.contactMessage;

  let valid = true;
  [nameInput, emailInput, messageInput].forEach(i => {
    i.style.borderColor = '';
    i.setAttribute('aria-invalid', 'false');
  });

  if (nameInput.value.trim().length < 2) {
    valid = false;
    nameInput.style.borderColor = '#ff5555';
    nameInput.setAttribute('aria-invalid', 'true');
  }

  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailPattern.test(emailInput.value.trim())) {
    valid = false;
    emailInput.style.borderColor = '#ff5555';
    emailInput.setAttribute('aria-invalid', 'true');
  }

  if (messageInput.value.trim().length < 10) {
    valid = false;
    messageInput.style.borderColor = '#ff5555';
    messageInput.setAttribute('aria-invalid', 'true');
  }

  return valid;
}

// Handle contact form submission (dummy, no actual backend)
contactForm.addEventListener('submit', e => {
  e.preventDefault();
  if (!validateContactForm()) {
    alert('Please fill out the form correctly.');
    return;
  }
  // Simulate sending
  const responseDiv = document.getElementById('contactResponse');
  responseDiv.textContent = 'Sending...';
  setTimeout(() => {
    responseDiv.textContent = 'Thanks for contacting GenBot! We will get back to you soon.';
    contactForm.reset();
  }, 1400);
});

// --- Chat send message ---
async function sendMessage() {
  const question = chatInput.value.trim();
  if (!question) return;

  chatInput.value = '';
  chatInput.disabled = true;
  btnSend.disabled = true;

  // Add user message immediately
  const userMsg = {
    id: generateUUID(),
    text: question,
    fromBot: false,
  };
  chatHistory.push(userMsg);
  addMessage(userMsg);
  if (autoSaveEnabled && googleUser) await saveChatMessage(userMsg.text, false);

  try {
    // OpenAI API call - replace with your backend proxy or directly call OpenAI here
    const openaiResponse = await fetchOpenAIResponse(question, currentPersonality);

    const botMsg = {
      id: generateUUID(),
      text: openaiResponse,
      fromBot: true,
    };
    chatHistory.push(botMsg);
    addMessage(botMsg);
    if (autoSaveEnabled && googleUser) await saveChatMessage(botMsg.text, true);
  } catch (err) {
    const errorMsg = {
      id: generateUUID(),
      text: 'Failed to connect to the server.',
      fromBot: true,
    };
    chatHistory.push(errorMsg);
    addMessage(errorMsg);
  }

  chatInput.disabled = false;
  btnSend.disabled = false;
  chatInput.focus();
}

// Generate UUID v4 (for local message IDs)
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// OpenAI API call helper - modify with your API key and endpoint
async function fetchOpenAIResponse(prompt, personality) {
  // Construct the prompt with personality
  const personalityPrompts = {
    friendly: "You are a friendly and helpful AI assistant.",
    professional: "You are a professional AI assistant providing clear and concise answers.",
    funny: "You are a funny AI assistant, adding light humor.",
    concise: "You provide short and concise answers.",
    detailed: "You provide detailed and thorough answers."
  };
  const finalPrompt = `${personalityPrompts[personality]}\nUser: ${prompt}\nAI:`;

  // Example direct OpenAI API call:
  const OPENAI_API_KEY = "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";

  const response = await fetch("https://api.openai.com/v1/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: "text-davinci-003",
      prompt: finalPrompt,
      max_tokens: 350,
      temperature: 0.7,
      top_p: 1,
      frequency_penalty: 0,
      presence_penalty: 0
    })
  });
  if (!response.ok) throw new Error("OpenAI API error");
  const data = await response.json();
  return data.choices[0].text.trim();
}

// Bind events
btnSend.addEventListener('click', sendMessage);
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Tabs keyboard navigation & click switching
tabs.forEach(tab => {
  tab.addEventListener('click', () => switchTab(tab.id));
  tab.addEventListener('keydown', e => {
    if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
      e.preventDefault();
      const next = tab.nextElementSibling || tabs[0];
      next.focus();
    } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
      e.preventDefault();
      const prev = tab.previousElementSibling || tabs[tabs.length - 1];
      prev.focus();
    }
  });
});

// --- Settings controls ---
settingAutoSave.addEventListener('change', e => {
  autoSaveEnabled = e.target.checked;
  if (autoSaveEnabled && googleUser) {
    listenToChatUpdates();
  } else if (chatListenersUnsub) {
    chatListenersUnsub();
    chatListenersUnsub = null;
  }
});

settingDarkMode.addEventListener('change', e => {
  darkModeEnabled = e.target.checked;
  document.body.classList.toggle('dark-mode', darkModeEnabled);
});

personalitySelect.addEventListener('change', e => {
  currentPersonality = e.target.value;
});

// Export chat history text
btnExport.addEventListener('click', () => {
  if (chatHistory.length === 0) return alert('No chat history to export.');
  let exportText = chatHistory
    .map(msg => (msg.fromBot ? 'GenBot: ' : 'You: ') + msg.text)
    .join('\n\n');
  const blob = new Blob([exportText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'GenBot_chat_history.txt';
  a.click();
  URL.revokeObjectURL(url);
});

// Clear chat history button
btnClear.addEventListener('click', () => {
  if (!confirm('Clear chat history? This cannot be undone.')) return;
  clearChatHistory();
});

// --- Google Sign-In handling ---

function showLoggedInUI() {
  document.getElementById('googleSignInDiv').style.display = 'none';
  btnLogout.hidden = false;
  settingAutoSave.disabled = false;
  settingAutoSave.checked = autoSaveEnabled;
  settingDarkMode.disabled = false;
  personalitySelect.disabled = false;

  if (autoSaveEnabled) listenToChatUpdates();
  else renderChatHistory(chatHistory);
}

function showLoggedOutUI() {
  document.getElementById('googleSignInDiv').style.display = 'block';
  btnLogout.hidden = true;
  settingAutoSave.disabled = true;
  settingDarkMode.disabled = true;
  personalitySelect.disabled = true;
  if (chatListenersUnsub) {
    chatListenersUnsub();
    chatListenersUnsub = null;
  }
  chatHistory = [];
  clearMessages();
}

// Google Identity Services initialization and callback
function handleCredentialResponse(response) {
  if (!response.credential) return;
  try {
    const user = jwt_decode(response.credential);
    googleUser = user;
    showLoggedInUI();
  } catch (e) {
    console.error('Google credential decode error:', e);
  }
}

btnLogout.addEventListener('click', () => {
  google.accounts.id.disableAutoSelect();
  auth.signOut();
  googleUser = null;
  showLoggedOutUI();
});

window.onload = () => {
  google.accounts.id.initialize({
    client_id: '472534217982-r7rmrlueav1r14snjvjl9j7bn7hb8nst.apps.googleusercontent.com',
    callback: handleCredentialResponse,
    auto_select: false,
    cancel_on_tap_outside: true,
  });
  google.accounts.id.renderButton(
    document.getElementById('googleSignInDiv'),
    { theme: 'outline', size: 'medium', width: 180 }
  );
  google.accounts.id.prompt();

  switchTab('tab-chat');
};
</script>
<!-- Part 3: JavaScript enhancements for live typing effect, personality profiles, chat saving, and UI -->

<script>
(() => {
  'use strict';

  // --- Additional State ---
  let personality = 'default'; // default personality profile
  let typingTimer = null; // for live typing effect

  // Personality profiles (you can add more)
  const personalities = {
    default: {
      name: 'GenBot Default',
      greeting: "Hi! I'm GenBot, your AI coding assistant.",
      colorTheme: '#3399ff',
      typingSpeed: 40, // ms per character for typing effect
    },
    friendly: {
      name: 'Friendly Bot',
      greeting: "Hey there! Ready to code some magic together?",
      colorTheme: '#66cc66',
      typingSpeed: 30,
    },
    professional: {
      name: 'Pro Bot',
      greeting: "Greetings. How can I assist you with your programming needs?",
      colorTheme: '#336699',
      typingSpeed: 50,
    },
  };

  // DOM references added in part 2
  // Adding new controls for personality
  const personalitySelect = document.createElement('select');
  personalitySelect.setAttribute('aria-label', 'Select AI personality');
  personalitySelect.style.margin = '12px 0';
  personalitySelect.style.padding = '8px 12px';
  personalitySelect.style.borderRadius = '12px';
  personalitySelect.style.border = 'none';
  personalitySelect.style.fontSize = '1rem';
  personalitySelect.style.color = '#003366';
  personalitySelect.style.fontWeight = '700';
  personalitySelect.style.userSelect = 'none';
  personalitySelect.style.cursor = 'pointer';
  for (const key in personalities) {
    const option = document.createElement('option');
    option.value = key;
    option.textContent = personalities[key].name;
    personalitySelect.appendChild(option);
  }

  // Append personality select in header-right
  const headerRight = document.querySelector('.header-right');
  headerRight.insertBefore(personalitySelect, headerRight.firstChild);

  // Apply personality styles
  function applyPersonality(person) {
    personality = person;
    const p = personalities[personality];
    currentTabTitle.style.color = p.colorTheme;
    // Change chat header color
    const chatHeader = document.querySelector('.chat-header');
    chatHeader.style.color = p.colorTheme;
    chatHeader.style.textShadow = `0 0 15px ${p.colorTheme}cc`;
  }

  personalitySelect.addEventListener('change', e => {
    applyPersonality(e.target.value);
  });

  applyPersonality('default'); // initial

  // Modified addMessage with live typing effect for bot
  async function addMessageTypingEffect(text, fromBot = false) {
    if (!fromBot || !animationsEnabled) {
      addMessage(text, fromBot);
      return;
    }

    // Create message div for bot
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', 'bot');
    msgDiv.style.opacity = '1';
    msgDiv.style.transform = 'translateY(0)';
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Type text letter by letter
    const p = personalities[personality];
    const speed = p.typingSpeed;

    let i = 0;
    return new Promise(resolve => {
      function type() {
        if (i < text.length) {
          msgDiv.textContent += text.charAt(i);
          i++;
          chatMessages.scrollTop = chatMessages.scrollHeight;
          typingTimer = setTimeout(type, speed);
        } else {
          resolve();
        }
      }
      type();
    });
  }

  // Override sendMessage to use live typing effect
  async function sendMessage() {
    const question = chatInput.value.trim();
    if (!question) return;

    addMessage(question, false);
    chatHistory.push({ text: question, fromBot: false });
    chatInput.value = '';
    chatInput.disabled = true;
    btnSend.disabled = true;

    try {
      // Replace with your backend URL or OpenAI API proxy
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: question, personality }),
      });
      if (!response.ok) throw new Error('Network error');

      const data = await response.json();
      if (data.error) {
        await addMessageTypingEffect('Error: ' + data.error, true);
        chatHistory.push({ text: 'Error: ' + data.error, fromBot: true });
      } else {
        await addMessageTypingEffect(data.response, true);
        chatHistory.push({ text: data.response, fromBot: true });
      }
    } catch (err) {
      await addMessageTypingEffect('Failed to connect to the server.', true);
      chatHistory.push({ text: 'Failed to connect to the server.', fromBot: true });
    }

    chatInput.disabled = false;
    btnSend.disabled = false;
    saveChatHistory();
  }

  // Override the original listeners with updated sendMessage with typing
  btnSend.removeEventListener('click', sendMessage); // remove previous if any
  btnSend.addEventListener('click', sendMessage);

  chatInput.removeEventListener('keydown', null);
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Load chat history with live typing disabled for loading
  function loadMessagesFromHistory() {
    clearMessages();
    for (const msg of chatHistory) {
      addMessage(msg.text, msg.fromBot);
    }
  }

  // Override saveChatHistory to also save personality profile
  function saveChatHistory() {
    if (!autoSaveEnabled || !googleUser) return;
    localStorage.setItem('GenBot_history_' + googleUser.sub, JSON.stringify({ chatHistory, personality }));
  }

  // Override loadChatHistory to load personality
  function loadChatHistory() {
    if (!googleUser) return;
    const data = localStorage.getItem('GenBot_history_' + googleUser.sub);
    if (data) {
      try {
        const parsed = JSON.parse(data);
        chatHistory = parsed.chatHistory || [];
        personality = parsed.personality || 'default';
        personalitySelect.value = personality;
        applyPersonality(personality);
      } catch {
        chatHistory = [];
        personality = 'default';
      }
    } else {
      chatHistory = [];
      personality = 'default';
    }
  }

  // Initial greeting with personality on login
  function greetUser() {
    const greeting = personalities[personality].greeting;
    if (greeting) addMessage(greeting, true);
  }

  // After login UI setup
  function showLoggedInUI() {
    googleSignInDiv.style.display = 'none';
    btnLogout.hidden = false;
    settingAutoSave.disabled = false;
    loadChatHistory();
    loadMessagesFromHistory();
    greetUser();
  }

  // Add more UI polish or future expansions here...

})();
</script>
<!-- Part 4: Additional features: Voice input/output, chat message search, improved UI controls -->

<script>
(() => {
  'use strict';

  // --- Voice input/output setup ---
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = SpeechRecognition ? new SpeechRecognition() : null;
  let isListening = false;

  // Create voice input button
  const voiceBtn = document.createElement('button');
  voiceBtn.textContent = 'ðŸŽ¤';
  voiceBtn.setAttribute('aria-label', 'Toggle voice input');
  voiceBtn.classList.add('btn-send');
  voiceBtn.style.padding = '10px 14px';
  voiceBtn.style.marginLeft = '6px';
  voiceBtn.style.fontSize = '1.2rem';
  voiceBtn.style.userSelect = 'none';
  voiceBtn.title = 'Toggle voice input';
  voiceBtn.disabled = !recognition;
  voiceBtn.style.background = '#3399ffcc';
  voiceBtn.style.boxShadow = '0 0 20px #3399ffcc, 0 0 35px #66aaffcc';

  // Add voice button next to send button
  btnSend.parentNode.appendChild(voiceBtn);

  if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
      isListening = true;
      voiceBtn.style.background = '#66cc66cc';
      voiceBtn.title = 'Listening... Click to stop';
    };

    recognition.onend = () => {
      isListening = false;
      voiceBtn.style.background = '#3399ffcc';
      voiceBtn.title = 'Toggle voice input';
    };

    recognition.onerror = (event) => {
      isListening = false;
      voiceBtn.style.background = '#3399ffcc';
      alert('Voice recognition error: ' + event.error);
    };

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.trim();
      if (transcript.length > 0) {
        chatInput.value = transcript;
        sendMessage();
      }
    };

    voiceBtn.addEventListener('click', () => {
      if (isListening) {
        recognition.stop();
      } else {
        recognition.start();
      }
    });
  }

  // --- Chat message search feature ---
  const searchInput = document.createElement('input');
  searchInput.type = 'search';
  searchInput.placeholder = 'Search chat...';
  searchInput.setAttribute('aria-label', 'Search chat messages');
  searchInput.style.margin = '8px 0 12px 0';
  searchInput.style.padding = '8px 14px';
  searchInput.style.width = '100%';
  searchInput.style.borderRadius = '14px';
  searchInput.style.border = 'none';
  searchInput.style.outline = 'none';
  searchInput.style.fontSize = '1rem';
  searchInput.style.color = '#003366';
  searchInput.style.fontWeight = '600';
  searchInput.style.userSelect = 'text';

  // Insert search input above chat messages
  const chatContainer = document.querySelector('.chat-container');
  chatContainer.insertBefore(searchInput, chatContainer.querySelector('.messages'));

  // Filter chat messages based on search input
  searchInput.addEventListener('input', () => {
    const filter = searchInput.value.toLowerCase();
    const msgDivs = chatMessages.querySelectorAll('.message');
    msgDivs.forEach(div => {
      const text = div.textContent.toLowerCase();
      div.style.display = text.includes(filter) ? '' : 'none';
    });
  });

  // --- Clear search input on tab switch ---
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      if (tab.id === 'tab-chat') {
        searchInput.value = '';
        // Show all messages again
        chatMessages.querySelectorAll('.message').forEach(div => div.style.display = '');
      }
    });
  });

  // --- Smooth scroll to latest message ---
  function scrollToBottom() {
    chatMessages.scrollTo({
      top: chatMessages.scrollHeight,
      behavior: 'smooth',
    });
  }

  // Override addMessage and addMessageTypingEffect to scroll smoothly
  const originalAddMessage = addMessage;
  addMessage = (text, fromBot = false) => {
    originalAddMessage(text, fromBot);
    scrollToBottom();
  };

  const originalAddMessageTypingEffect = addMessageTypingEffect;
  addMessageTypingEffect = async (text, fromBot = false) => {
    await originalAddMessageTypingEffect(text, fromBot);
    scrollToBottom();
  };

  // --- Loading spinner on sending message ---
  const spinner = document.createElement('div');
  spinner.classList.add('loading-spinner');
  spinner.style.display = 'none';
  spinner.style.width = '36px';
  spinner.style.height = '36px';
  spinner.style.border = '4px solid #3399ff88';
  spinner.style.borderTop = '4px solid #66aaffee';
  spinner.style.borderRadius = '50%';
  spinner.style.animation = 'spin 1s linear infinite';
  spinner.style.marginLeft = '10px';

  btnSend.parentNode.appendChild(spinner);

  // Show spinner during sendMessage
  async function sendMessageWithSpinner() {
    spinner.style.display = 'inline-block';
    btnSend.disabled = true;
    chatInput.disabled = true;
    await sendMessage();
    spinner.style.display = 'none';
    btnSend.disabled = false;
    chatInput.disabled = false;
  }

  btnSend.removeEventListener('click', sendMessage);
  btnSend.addEventListener('click', sendMessageWithSpinner);

  chatInput.removeEventListener('keydown', null);
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessageWithSpinner();
    }
  });

  // --- Spinner animation keyframes ---
  const spinnerStyles = document.createElement('style');
  spinnerStyles.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(spinnerStyles);

})();
</script>
<!-- Part 5: Advanced features: Chat import/export, persistent theme & settings, user profiles, command shortcuts, notifications -->

<script>
(() => {
  'use strict';

  // --- Persistent settings storage using localStorage ---
  const SETTINGS_KEY = 'GenBot_settings_v2';

  // Load settings from localStorage or default
  function loadSettings() {
    try {
      const stored = localStorage.getItem(SETTINGS_KEY);
      if (stored) return JSON.parse(stored);
    } catch {}
    return {
      autoSaveEnabled: false,
      darkModeEnabled: false,
      selectedPersonality: 'default',
      animationsEnabled: true,
      notificationEnabled: true,
    };
  }

  // Save settings to localStorage
  function saveSettings(settings) {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }

  let settings = loadSettings();

  // Initialize UI controls based on saved settings
  settingAutoSave.checked = settings.autoSaveEnabled;
  settingDarkMode.checked = settings.darkModeEnabled;
  settingAnimations.checked = settings.animationsEnabled;
  if (settingAnimations.disabled) settingAnimations.checked = true; // force enabled

  document.body.classList.toggle('dark-mode', settings.darkModeEnabled);
  autoSaveEnabled = settings.autoSaveEnabled;
  darkModeEnabled = settings.darkModeEnabled;
  animationsEnabled = settings.animationsEnabled;

  // --- User profiles and personalities ---

  const personalities = {
    default: {
      name: 'Default',
      promptPrefix: '',
      description: 'Friendly and helpful assistant.',
    },
    witty: {
      name: 'Witty',
      promptPrefix: 'Respond with witty and humorous answers. ',
      description: 'Adds humor and sarcasm.',
    },
    formal: {
      name: 'Formal',
      promptPrefix: 'Respond with professional and formal tone. ',
      description: 'Polished and serious.',
    },
    motivational: {
      name: 'Motivational',
      promptPrefix: 'Respond with encouragement and motivation. ',
      description: 'Inspires and uplifts.',
    },
  };

  // Create personality selector UI
  const settingsContainer = document.querySelector('.settings-container');
  const personalityDiv = document.createElement('div');
  personalityDiv.classList.add('settings-group');
  personalityDiv.style.marginTop = '24px';

  const personalityLabel = document.createElement('label');
  personalityLabel.textContent = 'Select AI Personality:';
  personalityLabel.style.fontWeight = '800';
  personalityLabel.style.color = '#55bbffcc';
  personalityLabel.style.marginBottom = '8px';
  personalityLabel.style.userSelect = 'none';

  personalityDiv.appendChild(personalityLabel);

  const personalitySelect = document.createElement('select');
  personalitySelect.style.padding = '10px 14px';
  personalitySelect.style.borderRadius = '14px';
  personalitySelect.style.background = '#002040dd';
  personalitySelect.style.color = '#bbe6ff';
  personalitySelect.style.border = 'none';
  personalitySelect.style.fontSize = '1rem';
  personalitySelect.style.fontWeight = '600';
  personalitySelect.style.userSelect = 'none';
  personalitySelect.title = 'Choose AI Personality';

  for (const key in personalities) {
    const option = document.createElement('option');
    option.value = key;
    option.textContent = personalities[key].name;
    personalitySelect.appendChild(option);
  }

  personalitySelect.value = settings.selectedPersonality || 'default';
  personalityDiv.appendChild(personalitySelect);
  settingsContainer.appendChild(personalityDiv);

  // Update settings on personality change
  personalitySelect.addEventListener('change', () => {
    settings.selectedPersonality = personalitySelect.value;
    saveSettings(settings);
  });

  // --- Command shortcuts ---

  // Define some slash commands with quick actions
  const commands = {
    '/help': {
      description: 'Show help message',
      action: () => {
        addMessage("Commands:\n/help - Show this message\n/clear - Clear chat history\n/export - Export chat history\n/import - Import chat history", true);
      },
    },
    '/clear': {
      description: 'Clear chat history',
      action: () => {
        if (confirm('Clear chat history? This cannot be undone.')) {
          chatHistory = [];
          clearMessages();
          if (googleUser) localStorage.removeItem('GenBot_history_' + googleUser.sub);
        }
      },
    },
    '/export': {
      description: 'Export chat history',
      action: () => btnExport.click(),
    },
    '/import': {
      description: 'Import chat history',
      action: () => importChatHistory(),
    },
  };

  // Intercept sendMessage to check for commands first
  const originalSendMessage = sendMessage;
  sendMessage = async () => {
    const text = chatInput.value.trim();
    if (!text) return;

    if (text.startsWith('/')) {
      const cmd = text.split(' ')[0].toLowerCase();
      if (commands[cmd]) {
        commands[cmd].action();
        chatInput.value = '';
        return;
      } else {
        addMessage(`Unknown command: ${cmd}. Type /help for available commands.`, true);
        chatInput.value = '';
        return;
      }
    }

    // Add personality prompt prefix before sending to API
    const personality = personalities[settings.selectedPersonality] || personalities.default;
    const promptWithPersonality = personality.promptPrefix + text;

    addMessage(text, false);
    chatHistory.push({ text: text, fromBot: false });
    chatInput.value = '';
    chatInput.disabled = true;
    btnSend.disabled = true;

    try {
      // Replace your backend URL or OpenAI API call
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: promptWithPersonality }),
      });
      if (!response.ok) throw new Error('Network error');

      const data = await response.json();
      if (data.error) {
        addMessage('Error: ' + data.error, true);
        chatHistory.push({ text: 'Error: ' + data.error, fromBot: true });
      } else {
        addMessage(data.response, true);
        chatHistory.push({ text: data.response, fromBot: true });
      }
    } catch (err) {
      addMessage('Failed to connect to the server.', true);
      chatHistory.push({ text: 'Failed to connect to the server.', fromBot: true });
    }

    chatInput.disabled = false;
    btnSend.disabled = false;
    saveChatHistory();
  };

  // --- Chat history import feature ---
  function importChatHistory() {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.txt,.json';
    fileInput.style.display = 'none';

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = reader.result.trim();
          // Try JSON parse first
          let imported = [];
          try {
            imported = JSON.parse(text);
            if (!Array.isArray(imported)) throw new Error('Invalid format');
          } catch {
            // Try to parse line-by-line text format "You: message" / "GenBot: message"
            imported = text.split('\n').map(line => {
              const m = line.match(/^(You|GenBot):\s*(.*)$/);
              if (m) {
                return { text: m[2], fromBot: m[1] === 'GenBot' };
              }
              return null;
            }).filter(Boolean);
          }
          if (imported.length === 0) throw new Error('No messages found');

          chatHistory = imported;
          saveChatHistory();
          loadMessagesFromHistory();
          alert('Chat history imported successfully.');
        } catch (error) {
          alert('Failed to import chat history: ' + error.message);
        }
      };
      reader.readAsText(file);
    });

    fileInput.click();
  }

  // Add Import button next to Export and Clear in settings
  const btnImport = document.createElement('button');
  btnImport.id = 'btnImport';
  btnImport.className = 'btn';
  btnImport.textContent = 'Import Chat History';
  btnImport.setAttribute('aria-label', 'Import chat history');
  btnImport.style.marginLeft = '8px';

  btnImport.addEventListener('click', importChatHistory);

  const settingsButtons = document.querySelector('.settings-buttons');
  settingsButtons.appendChild(btnImport);

  // --- Browser notifications when bot replies ---

  function notifyUser(message) {
    if (!settings.notificationEnabled) return;
    if (!('Notification' in window)) return;

    if (Notification.permission === 'granted') {
      new Notification('GenBot Reply', { body: message, icon: 'https://i.imgur.com/J2bRVPq.png' });
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          new Notification('GenBot Reply', { body: message, icon: 'https://i.imgur.com/J2bRVPq.png' });
        }
      });
    }
  }

  // Wrap original addMessage to call notifyUser on bot messages
  const addMessageOriginal = addMessage;
  addMessage = (text, fromBot = false) => {
    addMessageOriginal(text, fromBot);
    if (fromBot) notifyUser(text);
  };

  // --- Notification toggle setting ---
  const notifLabel = document.createElement('label');
  notifLabel.style.fontWeight = '700';
  notifLabel.style.fontSize = '1.1rem';
  notifLabel.style.display = 'flex';
  notifLabel.style.alignItems = 'center';
  notifLabel.style.gap = '12px';
  notifLabel.style.cursor = 'pointer';
  notifLabel.style.userSelect = 'none';
  notifLabel.style.marginTop = '18px';

  const notifCheckbox = document.createElement('input');
  notifCheckbox.type = 'checkbox';
  notifCheckbox.checked = settings.notificationEnabled;
  notifCheckbox.style.width = '20px';
  notifCheckbox.style.height = '20px';
  notifCheckbox.style.accentColor = '#33aaffcc';
  notifCheckbox.style.borderRadius = '6px';
  notifCheckbox.style.boxShadow = '0 0 6px #33aaffcc inset';
  notifCheckbox.style.transition = 'box-shadow 0.3s ease';

  notifCheckbox.addEventListener('change', e => {
    settings.notificationEnabled = e.target.checked;
    saveSettings(settings);
  });

  notifLabel.appendChild(notifCheckbox);
  notifLabel.appendChild(document.createTextNode('Enable desktop notifications'));
  settingsContainer.appendChild(notifLabel);

  // --- Keyboard shortcuts for accessibility ---
  window.addEventListener('keydown', e => {
    if (e.target === chatInput || e.target === personalitySelect) return; // ignore typing

    switch (e.key) {
      case 'c': // Clear chat
        e.preventDefault();
        commands['/clear'].action();
        break;
      case 'e': // Export chat
        e.preventDefault();
        btnExport.click();
        break;
      case 'i': // Import chat
        e.preventDefault();
        importChatHistory();
        break;
      case 'h': // Help
        e.preventDefault();
        commands['/help'].action();
        break;
      case 'd': // Toggle dark mode
        e.preventDefault();
        settingDarkMode.checked = !settingDarkMode.checked;
        settingDarkMode.dispatchEvent(new Event('change'));
        break;
    }
  });

})();
</script>

<style>
  /* Personality select styles */
  select {
    transition: box-shadow 0.3s ease;
  }
  select:focus {
    box-shadow:
      0 0 24px #3399ffcc,
      inset 0 0 28px #44bbffcc;
    outline: none;
  }
</style>
