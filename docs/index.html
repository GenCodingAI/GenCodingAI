<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GlizzyBot — Your Sci-Fi AI Chatbot</title>

<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

<style>
/* === Reset & Base === */
*,
*::before,
*::after {
  box-sizing: border-box;
}

body,
html {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #0a0f1a;
  color: #cce6ff;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
}
::-webkit-scrollbar-track {
  background: #11182b;
  border-radius: 4px;
}
::-webkit-scrollbar-thumb {
  background: #1a75ff;
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: #3a9cff;
}

/* === Page container === */
.page {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 960px;
  margin: 0 auto;
  box-shadow:
    0 0 10px #0af,
    0 0 30px #08f,
    inset 0 0 40px #05f;
  border-radius: 12px;
  background: linear-gradient(135deg, #001028 0%, #001a47 100%);
  overflow: hidden;
}

/* === Header === */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #00182a;
  padding: 0 20px;
  height: 64px;
  border-bottom: 1px solid #1048ff44;
  box-shadow: 0 2px 12px #0a35ff88;
}

.brand {
  display: flex;
  align-items: center;
  gap: 8px;
  user-select: none;
}

.logo-img {
  width: 40px;
  height: 40px;
  filter: drop-shadow(0 0 6px #33aaff);
  border-radius: 8px;
}

.logo {
  font-weight: 900;
  font-size: 1.6rem;
  color: #1af;
  letter-spacing: 1.4px;
  text-shadow:
    0 0 8px #33aaff,
    0 0 15px #55ccff;
}

.logo span {
  color: #a2d9ff;
  text-shadow:
    0 0 10px #5ef,
    0 0 25px #6ff;
}

/* === Top Controls === */
.top-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

button.ghost {
  background: transparent;
  border: 1.5px solid #3f8cff;
  color: #88bbff;
  font-weight: 600;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s ease;
  user-select: none;
  filter: drop-shadow(0 0 5px #44aaff88);
}

button.ghost:hover:not(.hidden) {
  background: #1a3f9f22;
  border-color: #66aaff;
  color: #bbddff;
  filter: drop-shadow(0 0 10px #55aaffcc);
}

button.ghost:active {
  transform: scale(0.96);
}

button.ghost.hidden {
  display: none;
}

/* === Main Chat Area === */
.chat-wrap {
  display: flex;
  flex: 1;
  background: #05102a;
  overflow: hidden;
  position: relative;
}

/* === Side Panel === */
.side-panel {
  width: 260px;
  background: #0a1a3a;
  border-right: 1px solid #0f3bbf66;
  padding: 24px 20px;
  color: #a4caffcc;
  user-select: none;
  box-shadow: inset -2px 0 15px #0550ff55;
  transition: transform 0.3s ease;
  overflow-y: auto;
}

.side-panel.hidden {
  transform: translateX(-280px);
  pointer-events: none;
  opacity: 0;
}

.side-panel h2 {
  font-weight: 700;
  font-size: 1.4rem;
  margin-bottom: 20px;
  color: #55aaffcc;
  text-shadow: 0 0 10px #3f7cffaa;
}

.setting {
  margin-bottom: 18px;
  font-weight: 600;
  cursor: pointer;
}

.setting input[type="checkbox"] {
  margin-right: 10px;
  accent-color: #33aaff;
  cursor: pointer;
}

/* === Chat Section === */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 24px 32px;
  overflow: hidden;
  position: relative;
  color: #cce6ff;
  user-select: text;
}

.header-hint {
  margin-bottom: 18px;
}

.header-hint h2 {
  margin: 0 0 6px 0;
  font-weight: 800;
  font-size: 1.8rem;
  color: #2bd1ff;
  text-shadow:
    0 0 8px #33c7ff,
    0 0 20px #55d4ff;
}

.header-hint p.muted {
  margin: 0;
  font-size: 0.9rem;
  font-weight: 600;
  color: #77aee6aa;
}

/* === Messages Container === */
.messages {
  flex: 1;
  overflow-y: auto;
  padding-right: 10px;
  margin-bottom: 12px;
  background: #001530;
  border-radius: 12px;
  box-shadow:
    inset 0 0 15px #0078ff44,
    0 0 12px #0078ff88;
  scrollbar-width: thin;
  scrollbar-color: #3399ff44 transparent;
}

/* Message bubbles */
.message {
  max-width: 80%;
  padding: 14px 20px;
  border-radius: 20px;
  margin-bottom: 12px;
  font-size: 1rem;
  line-height: 1.4;
  user-select: text;
  word-wrap: break-word;
  box-shadow: 0 0 10px #33aaff33;
  transition: background-color 0.3s ease;
}

.message.user {
  background: linear-gradient(135deg, #0043ca, #2a9fff);
  color: #d0e9ff;
  margin-left: auto;
  text-align: right;
  box-shadow:
    0 0 15px #2b9fffcc,
    0 2px 8px #0d6fd6cc;
}

.message.bot {
  background: linear-gradient(135deg, #0a3154, #00437f);
  color: #a9d4ff;
  margin-right: auto;
  box-shadow:
    0 0 15px #3388ffcc,
    0 2px 8px #072c5acc;
}

/* === Composer Input Area === */
.composer {
  display: flex;
  gap: 12px;
  padding: 6px 0;
}

#messageInput {
  flex: 1;
  font-size: 1.05rem;
  padding: 12px 16px;
  border-radius: 12px;
  border: none;
  outline: none;
  background: #001830;
  color: #b3e0ff;
  box-shadow:
    inset 0 0 10px #2b94ffaa;
  transition: box-shadow 0.3s ease;
}

#messageInput:focus {
  box-shadow:
    0 0 12px #3cb0ffdd,
    inset 0 0 18px #3cb0ffcc;
}

button.send {
  background: #3399ff;
  color: #e1f0ff;
  font-weight: 700;
  font-size: 1.1rem;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  cursor: pointer;
  box-shadow:
    0 0 10px #44aaffee,
    0 0 20px #3399ffcc;
  user-select: none;
  transition: background 0.25s ease;
}

button.send:hover {
  background: #44aaff;
  box-shadow:
    0 0 15px #55bbffee,
    0 0 25px #44aaffcc;
}

button.send:active {
  transform: scale(0.95);
}

/* === Footer === */
.footer {
  font-size: 0.9rem;
  text-align: center;
  padding: 14px 0;
  color: #44aaffaa;
  user-select: none;
  text-shadow: 0 0 6px #2299ff88;
  background: #001830;
  border-top: 1px solid #002a5a;
}

/* === Responsive === */
@media (max-width: 768px) {
  .page {
    max-width: 100%;
    border-radius: 0;
  }

  .side-panel {
    position: absolute;
    z-index: 10;
    height: calc(100vh - 64px);
    top: 64px;
    left: 0;
    box-shadow: 2px 0 20px #0040ffcc;
    background: #051943cc;
    backdrop-filter: blur(8px);
  }

  .side-panel.hidden {
    transform: translateX(-280px);
  }

  .chat-wrap {
    flex-direction: column;
  }

  .chat-area {
    padding: 16px;
  }
}

/* === Animations for side panel & messages === */
.side-panel,
.message {
  will-change: transform, opacity;
}
</style>
</head>

<body>
<div class="page" role="main" aria-label="GlizzyBot AI Chat Application">

  <!-- Header -->
  <header class="topbar" role="banner">
    <div class="brand" aria-label="Site Logo and Name">
      <img src="https://i.imgur.com/xcR6yM2.png" alt="GlizzyBot Logo" class="logo-img" />
      <div class="logo">Glizzy<span>Bot</span></div>
    </div>

    <div class="top-controls" id="topControls" aria-label="User controls and sign in">
      <div id="gsi-button" aria-live="polite" aria-atomic="true" aria-relevant="additions"></div>
      <button class="ghost hidden" id="logoutBtn" aria-label="Log out">Logout</button>
      <button class="ghost hidden" id="settingsBtn" aria-label="Open settings">⚙️</button>
    </div>
  </header>

  <!-- Main content area -->
  <section class="chat-wrap">
    <!-- Side panel for settings -->
    <aside id="sidePanel" class="side-panel hidden" role="region" aria-label="Settings panel" aria-hidden="true">
      <h2>Settings</h2>
      <label class="setting" for="animationsToggle">
        <input type="checkbox" id="animationsToggle" checked />
        Enable Animations
      </label>
      <label class="setting" for="fancyToggle">
        <input type="checkbox" id="fancyToggle" checked />
        Fancy Message Animations
      </label>
      <label class="setting" for="saveToggle">
        <input type="checkbox" id="saveToggle" />
        Save Chat History (requires login)
      </label>
      <button class="ghost" id="exportBtn" aria-label="Export chat history">Export History</button>
      <button class="ghost" id="clearBtn" aria-label="Clear chat history">Clear History</button>
    </aside>

    <!-- Chat area -->
    <article class="chat-area" role="main" aria-live="polite" aria-atomic="false" aria-relevant="additions">
      <div class="header-hint">
        <h2>Ask GlizzyBot anything</h2>
        <p class="muted">Public chat is open. Sign in with Google to save history &amp; unlock extras.</p>
      </div>

      <section id="messages" class="messages" tabindex="0" aria-label="Chat messages"></section>

      <div class="composer">
        <input
          id="messageInput"
          name="messageInput"
          type="text"
          placeholder="Type your question and press Enter..."
          autocomplete="off"
          aria-label="Chat message input"
          spellcheck="false"
          autocorrect="off"
          autocapitalize="none"
          aria-live="off"
        />
        <button class="send" id="sendBtn" aria-label="Send message">Send</button>
      </div>
    </article>
  </section>

  <footer class="footer" role="contentinfo" aria-live="polite">
    Made with ✨ and a little sci-fi glow.
  </footer>
</div>

<script>
(() => {
  // Elements
  const messages = document.getElementById('messages');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  const sidePanel = document.getElementById('sidePanel');
  const animationsToggle = document.getElementById('animationsToggle');
  const saveToggle = document.getElementById('saveToggle');
  const fancyToggle = document.getElementById('fancyToggle');
  const exportBtn = document.getElementById('exportBtn');
  const clearBtn = document.getElementById('clearBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const gsiButtonContainer = document.getElementById('gsi-button');

  // State
  let googleUser = null;
  let chatHistory = [];

  // Google Sign-In callback
  function handleCredentialResponse(response) {
    try {
      const userObject = jwt_decode(response.credential);
      googleUser = userObject;
      showLoggedInUI();
      loadHistory();
    } catch (err) {
      console.error('Error decoding Google credential:', err);
      googleUser = null;
    }
  }

  // Show/hide UI elements on login/logout
  function showLoggedInUI() {
    gsiButtonContainer.classList.add('hidden');
    logoutBtn.classList.remove('hidden');
    settingsBtn.classList.remove('hidden');
    saveToggle.disabled = false;
  }

  function showLoggedOutUI() {
    googleUser = null;
    gsiButtonContainer.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    saveToggle.disabled = true;
    chatHistory = [];
    clearMessages();
  }

  // Clear chat display
  function clearMessages() {
    messages.innerHTML = '';
  }

  // Add message bubble
  function addMessage(text, fromBot = false) {
    const msg = document.createElement('div');
    msg.className = 'message ' + (fromBot ? 'bot' : 'user');
    msg.textContent = text;

    if (fancyToggle.checked) {
      msg.style.opacity = '0';
      msg.style.transform = 'translateY(10px)';
      messages.appendChild(msg);
      requestAnimationFrame(() => {
        msg.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
        msg.style.opacity = '1';
        msg.style.transform = 'translateY(0)';
      });
    } else {
      messages.appendChild(msg);
    }
    messages.scrollTop = messages.scrollHeight;
  }

  // Save chat history to localStorage if signed in & saving enabled
  function saveHistory() {
    if (!googleUser || !saveToggle.checked) return;
    localStorage.setItem('glizzybot_history_' + googleUser.sub, JSON.stringify(chatHistory));
  }

  // Load chat history from localStorage
  function loadHistory() {
    if (!googleUser || !saveToggle.checked) {
      chatHistory = [];
      clearMessages();
      return;
    }
    const stored = localStorage.getItem('glizzybot_history_' + googleUser.sub);
    if (stored) {
      chatHistory = JSON.parse(stored);
      clearMessages();
      chatHistory.forEach(msg => addMessage(msg.text, msg.fromBot));
    }
  }

  // Add message to history and save
  function appendToHistory(text, fromBot) {
    chatHistory.push({ text, fromBot });
    if (chatHistory.length > 100) chatHistory.shift(); // limit history
    saveHistory();
  }

  // Send message to backend
  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    addMessage(text, false);
    appendToHistory(text, false);

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: text, user: googleUser ? googleUser.sub : null }),
      });
      if (!res.ok) throw new Error('Network error');
      const data = await res.json();
      if (data.error) {
        addMessage('Error: ' + data.error, true);
        appendToHistory('Error: ' + data.error, true);
      } else {
        addMessage(data.response, true);
        appendToHistory(data.response, true);
      }
    } catch (err) {
      addMessage('Failed to connect to the server.', true);
      appendToHistory('Failed to connect to the server.', true);
    }
  }

  // Toggle side panel
  function toggleSettings() {
    const hidden = sidePanel.classList.toggle('hidden');
    sidePanel.setAttribute('aria-hidden', hidden ? 'true' : 'false');
  }

  // Export chat history as text file
  function exportHistory() {
    if (chatHistory.length === 0) return alert('No chat history to export.');
    let exportText = chatHistory
      .map(msg => (msg.fromBot ? 'GlizzyBot: ' : 'You: ') + msg.text)
      .join('\n');
    const blob = new Blob([exportText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'glizzybot_chat_history.txt';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Clear chat history both UI and storage
  function clearHistory() {
    if (!confirm('Clear chat history? This cannot be undone.')) return;
    chatHistory = [];
    clearMessages();
    if (googleUser) localStorage.removeItem('glizzybot_history_' + googleUser.sub);
  }

  // Log out Google user
  function logout() {
    google.accounts.id.disableAutoSelect();
    googleUser = null;
    showLoggedOutUI();
  }

  // Event listeners
  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  settingsBtn.addEventListener('click', toggleSettings);
  exportBtn.addEventListener('click', exportHistory);
  clearBtn.addEventListener('click', clearHistory);
  logoutBtn.addEventListener('click', logout);

  // Google Identity API Init
  window.onload = () => {
    google.accounts.id.initialize({
      client_id: '472534217982-bjn2mbaq2t1f1s8jenqh6t389u595kcf.apps.googleusercontent.com',
      callback: handleCredentialResponse,
      auto_select: false,
      cancel_on_tap_outside: false,
    });
    google.accounts.id.renderButton(
      gsiButtonContainer,
      { theme: 'outline', size: 'large', width: 200 }
    );
    google.accounts.id.prompt();

    // Disable save toggle if not logged in
    saveToggle.disabled = true;
  };
})();
</script>
</body>
</html>
